const data = require("./data/fips-counties")

const getByFipsAndState = (fips, state) => {
  if (!fips) throw new Error("You must provide a three digit fips code.");
  if (!state || state.length !== 2) throw new Error("You must provide a two letter state abbreviation.");
  if (typeof fips !== "string") throw new Error("Fips code must be a string.");
  if (fips.length !== 3) throw new Error("Fips code must be three digits.");
  const row = data.find(county => county.countyfp === fips && county.state === state.toUpperCase());

  return {
    state: row.state,
    county: row.countyname,
    countyfp: row.countyfp,
    fips: `${row.statefp}${row.countyfp}`
  };
};

const getByCountyAndState = (state, county) => {
  if (!state || !county)
    throw new Error("You must provide a state abbreviation and county name.");
  if (state.length !== 2)
    throw new Error("State must be a two letter state abbreviation.");
  if (typeof state !== "string")
    throw new Error("State abbreviation must be a string.");
  if (typeof county !== "string")
    throw new Error("County name must be a string.");

  const abbreviation = state.toUpperCase();
  const match = data.find(
    row =>
      row.countyname === county ||
      (row.countyname === `${county} County` && row.state === abbreviation)
  );

  return {
    state: match.state,
    county: match.countyname,
    countyfp: match.countyfp,
    fips: `${match.statefp}${match.countyfp}`
  }
};

const get = options => {
  if (options.fips) return getByFipsAndState(options.fips, options.state);
  return getByCountyAndState(options.state, options.county);
};

const getCountiesByState = state => {
  if (state.length !== 2)
    throw new Error("State must be a two letter state abbreviation.");
  return data.filter(c => c.state === state.toUpperCase());
}

const search = regex => {
  if (!regex instanceof RegExp) return new Error('You must provide a regular expression.');
  return data.filter(row =>
    (
      regex.test(row.countyname) ||
      regex.test(row.countyfp) ||
      regex.test(row.statefp) ||
      regex.test(row.state)
    )
  ).map(result => ({
    state: result.state,
    county: result.countyname,
    countyfp: result.countyfp,
    fips: `${result.statefp}${result.countyfp}`
  }));
};

module.exports = {
  get,
  getByCountyAndState,
  getByFipsAndState,
  getCountiesByState,
  search
};
